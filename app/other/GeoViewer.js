/*b7ab623e5998fc6d0e6e44d20017e364ae81d5b2*/var GeoViewer=function(viewingMap){var DEFAULT_ZOOM=14;var map;var geocoder;var trafficLayer;var geocoderMarker;var positionIncreasingAccuracy=false;var positionWatchId;var positionAccuracy;var positionMarker;var positionCircle;var loadingOverlay;var crosshairsOverlay;var styles;var iconOptimized=true;var eventInfoOn="click";var eventInfoHandler;var eventLazyShowMode=false;var eventLazyShowListener;var eventMinimumZoom;var currentEvent;var openInfoWindow;var markerCache=[];var circleCache=[];var polygonCache=[];var polylineCache=[];var blipCache=[];map=viewingMap;google.maps.event.addListener(map,"click",closeInfoWindow);eventInfoHandler=new GeoDefaultEventInfo();geocoder=new google.maps.Geocoder();this.getMarkerCache=function(){return markerCache};this.closeInfoWindow=function(){if(openInfoWindow!=null){eventInfoHandler.closeInfoWindow(openInfoWindow)}currentEvent=null};this.setStyles=function(geoStyles){styles=geoStyles};this.setIconOptimized=function(optimize){iconOptimized=optimize};this.setEventInfoHandler=function(newHandler){eventInfoHandler=newHandler};this.getEventInfoHandler=function(){return eventInfoHandler};this.setEventInfoOn=function(event){eventInfoOn=event};this.setEventMinimumZoom=function(level){eventMinimumZoom=level};this.setEventLazyShowMode=function(mode){if(mode&&eventLazyShowListener==null){eventLazyShowListener=google.maps.event.addListener(map,"bounds_changed",lazyShowEvents)}else{if(!mode&&eventLazyShowListener!=null){google.maps.event.removeListener(eventLazyShowListener)}}eventLazyShowMode=mode};this.setPositionOptions=function(options){positionOptions=options};this.setPositionIncreasingAccuracy=function(option){positionIncreasingAccuracy=option};this.loadEvents=function(href,centerMap,callback){load(href,centerMap)};this.loadBlips=function(href,centerMap,callback){load(href,centerMap)};this.addEvents=function(text,centerMap,callback){if(!ensureStyles()){return}closeInfoWindow();parseEvents(text);if(centerMap){centerMapPrivate()}if(eventLazyShowMode){lazyShowEvents()}if(callback!=null){callback()}};this.atGeocoder=function(address,failureCallback){if(!ensureStyles()){return}if(loadingOverlay!=null){loadingOverlay.show()}var bounds=provideGeocoderBounds();geocoder.geocode({address:address,bounds:bounds},function(results,status){if(status==google.maps.GeocoderStatus.OK){atGeocoderResultPrivate(results[0])}else{if(failureCallback!=null){failureCallback()}}if(loadingOverlay!=null){loadingOverlay.hide()}})};this.getGeocoderResults=function(address,callback){if(!ensureStyles()){return}var bounds=provideGeocoderBounds();geocoder.geocode({address:address,bounds:bounds},callback)};this.atGeocoderResult=function(result){if(!ensureStyles()){return}atGeocoderResultPrivate(result)};this.atCurrentPosition=function(failureCallback){if(!ensureStyles()){return}if(!navigator||!navigator.geolocation){if(failureCallback!=null){failureCallback()}return}if(loadingOverlay!=null){loadingOverlay.show()}navigator.geolocation.getCurrentPosition(showCurrentPosition,function(error){if(failureCallback!=null){failureCallback(error)}if(loadingOverlay!=null){loadingOverlay.hide()}clearCurrentPosition()},{enableHighAccuracy:true,maximumAge:30000,timeout:5000})};this.centerMap=function(defaultZoom){centerMapPrivate(defaultZoom)};this.clearEvents=function(){console.log("clearEvents");closeInfoWindow();for(var i=0;i<circleCache.length;i++){circleCache[i].setMap(null)}for(var i=0;i<markerCache.length;i++){markerCache[i].setMap(null)}for(var i=0;i<polygonCache.length;i++){polygonCache[i].setMap(null)}for(var i=0;i<polylineCache.length;i++){polylineCache[i].setMap(null)}markerCache=[];circleCache=[];polygonCache=[];polylineCache=[]};this.clearBlips=function(){closeInfoWindow();for(var i=0;i<blipCache.length;i++){blipCache[i].setMap(null)}blipCache=[]};this.clearGeocoder=function(){closeInfoWindow();if(geocoderMarker){geocoderMarker.setMap(null);geocoderMarker=null}};this.clearPosition=function(){clearCurrentPosition()};this.hideTrafficLayer=function(){if(trafficLayer!=null){trafficLayer.setMap(null)}};this.showTrafficLayer=function(){if(trafficLayer==null){trafficLayer=new google.maps.TrafficLayer()}trafficLayer.setMap(map)};this.hideEvents=function(){closeInfoWindow();for(var i=0;i<circleCache.length;i++){circleCache[i].setMap(null)}for(var i=0;i<markerCache.length;i++){markerCache[i].setMap(null)}for(var i=0;i<polygonCache.length;i++){polygonCache[i].setMap(null)}for(var i=0;i<polylineCache.length;i++){polylineCache[i].setMap(null)}};this.showEvents=function(){closeInfoWindow();for(var i=0;i<circleCache.length;i++){circleCache[i].setMap(map)}for(var i=0;i<markerCache.length;i++){markerCache[i].setMap(map)}for(var i=0;i<polygonCache.length;i++){polygonCache[i].setMap(map)}for(var i=0;i<polylineCache.length;i++){polylineCache[i].setMap(map)}};this.hideBlips=function(){closeInfoWindow();for(var i=0;i<blipCache.length;i++){blipCache[i].setMap(null)}};this.showBlips=function(){closeInfoWindow();for(var i=0;i<blipCache.length;i++){blipCache[i].setMap(map)}};this.showCrosshairs=function(){crosshairsOverlay.show()};this.hideCrosshairs=function(){crosshairsOverlay.hide()};this.getCurrentEvent=function(){return currentEvent};this.getCurrentEventDescription=function(type){return styles[type].Description};this.getMapCenterAsXMLString=function(){var center=map.getCenter();return"<Point>"+center.lat()+","+center.lng()+"</Point>"};function load(href,centerMap,callback){if(!ensureStyles()){return}var request=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;if(loadingOverlay!=null){loadingOverlay.show()}request.onreadystatechange=function(){if(request.readyState==4){if(request.status==200){request.onreadystatechange=doNothing;closeInfoWindow();parseEvents(eval("("+request.responseText+")"));if(centerMap){centerMapPrivate()}if(callback!=null){callback()}}else{console.log("GeoViewer: unexpected problem while loading events:\n"+request.statusText)}}if(loadingOverlay!=null){loadingOverlay.hide()}};request.open("GET",href,true);request.send(null)}function centerMapPrivate(defaultZoom){var bounds=new google.maps.LatLngBounds();var counter=0;var path;for(var i=0;i<markerCache.length;++i){bounds.extend(markerCache[i].getPosition());counter++}for(var i=0;i<polygonCache.length;++i){path=polygonCache[i].getPath();for(var j=0;j<path.getLength();++j){bounds.extend(path.getAt(j));counter++}}for(var i=0;i<polylineCache.length;++i){path=polylineCache[i].getPath();for(var j=0;j<path.getLength();++j){bounds.extend(path.getAt(j));counter++}}if(!bounds.isEmpty()){map.fitBounds(bounds)}else{if(defaultZoom){map.setZoom(defaultZoom)}}}function showCurrentPosition(pos){var latLng=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);if(positionMarker){map.panTo(latLng);map.setZoom(DEFAULT_ZOOM);positionMarker.setPosition(latLng);if(positionCircle!=null){positionCircle.setRadius(pos.coords.accuracy)}}else{map.panTo(latLng);map.setZoom(DEFAULT_ZOOM);positionMarker=new google.maps.Marker({map:map,position:latLng});var imageOptions=getStyleProperty("positionMarker","markerimage");if(imageOptions!=null){positionMarker.setIcon(createMarkerImage(imageOptions))}var circleOptions=getStyleProperty("positionMarker","circle");if(circleOptions!=null){positionCircle=new google.maps.Circle(circleOptions);positionCircle.bindTo("center",positionMarker,"position");positionCircle.setRadius(pos.coords.accuracy);positionCircle.setMap(map)}}if(loadingOverlay!=null){loadingOverlay.hide()}if(positionIncreasingAccuracy){positionAccuracy=pos.coords.accuracy;alert("first attempt accuracy: "+positionAccuracy);positionWatchId=navigator.geolocation.watchPosition(updateCurrentPosition,clearPositionWatch,{enableHighAccuracy:true,maximumAge:0,timeout:5000})}}function updateCurrentPosition(pos){var latLng=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);if(positionWatchId==null){return}if(positionMarker!=null){positionMarker.setPosition(latLng);if(positionCircle!=null){positionCircle.setRadius(pos.coords.accuracy)}if(pos.coords.accuracy<positionAccuracy){positionAccuracy=pos.coords.accuracy;alert("better accuracy: "+positionAccuracy)}else{clearPositionWatch()}}else{clearPositionWatch()}}function clearPositionWatch(){navigator.geolocation.clearWatch(positionWatchId);positionWatchId=null;alert("position watch cleared: "+positionAccuracy)}function clearCurrentPosition(){if(positionMarker){positionMarker.setMap(null);positionMarker=null;if(positionCircle){positionCircle.setMap(null);positionCircle=null}}positionAccuracy=-1}function atGeocoderResultPrivate(result){closeInfoWindow();if(geocoderMarker){geocoderMarker.setMap(null)}map.panTo(result.geometry.location);map.setZoom(DEFAULT_ZOOM);geocoderMarker=new google.maps.Marker({map:map,animation:google.maps.Animation.DROP,position:result.geometry.location});var imageOptions=getStyleProperty("geocoderMarker","markerimage");if(imageOptions!=null){geocoderMarker.setIcon(createMarkerImage(imageOptions))}imageOptions=getStyleProperty("geocoderMarker","ShadowImage");if(imageOptions!=null){geocoderMarker.setShadow(createMarkerImage(imageOptions))}}function lazyShowEvents(){if(eventMinimumZoom!=null&&map.getZoom()<eventMinimumZoom){for(var i=0;i<circleCache.length;i++){circleCache[i].setMap(null)}for(var i=0;i<markerCache.length;i++){markerCache[i].setMap(null)}for(var i=0;i<polygonCache.length;i++){polygonCache[i].setMap(null)}for(var i=0;i<polylineCache.length;i++){polylineCache[i].setMap(null)}return}var viewport=map.getBounds();if(viewport==null){return}for(var i=0;i<circleCache.length;i++){if(circleCache[i].getMap(map)==null&&viewport.intersects(circleCache[i].getBounds())){circleCache[i].setMap(map)}}for(var i=0;i<markerCache.length;i++){if(markerCache[i].getMap()==null&&viewport.contains(markerCache[i].getPosition())){markerCache[i].setMap(map)}}for(var i=0;i<polygonCache.length;i++){if(polygonCache[i].getMap()==null){var path=polygonCache[i].getPath();for(var j=0;j<path.getLength();j++){if(viewport.contains(path.getAt(j))){polygonCache[i].setMap(map);break}}}}for(var i=0;i<polylineCache.length;i++){if(polylineCache[i].getMap()==null){var path=polylineCache[i].getPath();for(var j=0;j<path.getLength();j++){if(viewport.contains(path.getAt(j))){polylineCache[i].setMap(map);break}}}}}function parseEvents(events){for(var i=0;i<events.length;i++){if(events[i].geometria.tipo=="Point"||events[i].geometria.tipo=="Circle"){createMarker(events[i])}else{if(events[i].geometria.tipo=="Polygon"){createPolygon(events[i])}else{if(events[i].geometria.tipo=="Polyline"){createPolyline(events[i])}else{console.log("GeoViewer: unrecognized geometry:\n"+geometry.tipo)}}}}}function createMarkerImage(markerImageOptions){ensureMarkerImageOptions(markerImageOptions);var markerImage=new google.maps.MarkerImage(markerImageOptions.url,new google.maps.Size(parseInt(markerImageOptions.size.split(",")[0]),parseInt(markerImageOptions.size.split(",")[1])),new google.maps.Point(parseInt(markerImageOptions.origin.split(",")[0]),parseInt(markerImageOptions.origin.split(",")[1])),new google.maps.Point(parseInt(markerImageOptions.anchor.split(",")[0]),parseInt(markerImageOptions.anchor.split(",")[1])),new google.maps.Size(parseInt(markerImageOptions.size.split(",")[0]),parseInt(markerImageOptions.size.split(",")[1])));return markerImage}function createMarker(event){var type=event.type;var path=GeoViewer.parsePath(event.geometria.valore);if(path.length<1){return}var marker=provideMarker(event,path[0]);if(event.geometria.tipo=="Circle"){var radius=parseFloat(event.geometria.radius);var circleOptions=getStyleProperty(type,"circle");if(circleOptions==null){circleOptions={}}if(!eventLazyShowMode){circleOptions.map=map}circleOptions.radius=radius;var circle=new google.maps.Circle(circleOptions);circle.bindTo("center",marker,"position");circleCache.push(circle);provideEventInfo(circle,event)}}function createPolygon(event){var type=event.type;var path=GeoViewer.parsePath(event.geometria.valore);if(path.length<1){return}var polygonStyle=getStyleProperty(type,"polygon");if(polygonStyle==null){polygonStyle={}}var polygon=new google.maps.Polygon(polygonStyle);polygon.setPaths([path]);if(!eventLazyShowMode){polygon.setMap(map)}polygonCache.push(polygon);provideEventInfo(polygon,event);polygonStyle=(polygonStyle.addMarker||null);if(polygonStyle=="first"){provideMarker(event,path[0])}else{if(polygonStyle=="last"){provideMarker(event,path[path.length-1])}else{if(polygonStyle=="center"){provideMarker(event,centroidOfPoints(path))}}}}function createPolyline(event){var type=event.type;var path=GeoViewer.parsePath(event.geometria.valore);if(path.length<1){return}var polylineStyle=getStyleProperty(type,"polyline");if(polylineStyle==null){polylineStyle={}}var polyline=new google.maps.Polyline(polylineStyle);polyline.setPath([path]);if(!eventLazyShowMode){polyline.setMap(map)}polylineCache.push(polyline);provideEventInfo(polyline,event);polylineStyle=(polylineStyle.addMarker||null);if(polylineStyle=="first"){provideMarker(event,path[0])}else{if(polylineStyle=="last"){provideMarker(event,path[path.length-1])}else{if(polylineStyle=="center"){provideMarker(event,midpointOnPath(path))}}}}function provideMarker(event,position){var title=event.title;var type=event.type;var id=event.id;var markerOptions=getStyleProperty(type,"marker");if(markerOptions==null){markerOptions={}}markerOptions.position=position;if(!eventLazyShowMode){markerOptions.map=map}markerOptions.title=title;markerOptions.id=id;var markerImageOptions=getStyleProperty(type,"markerimage");if(markerImageOptions!=null){markerOptions.icon=createMarkerImage(markerImageOptions);markerOptions.optimized=iconOptimized}var marker=new google.maps.Marker(markerOptions);if(eventInfoHandler.isBlip(event)){blipCache.push(marker)}else{markerCache.push(marker)}provideEventInfo(marker,event);return marker}function provideEventInfo(gObject,event){google.maps.event.addListener(gObject,eventInfoOn,function(e){closeInfoWindow();openInfoWindow=eventInfoHandler.openInfoWindow(gObject,event,e.latLng,map);currentEvent=event})}function provideGeocoderBounds(){var boundsOptions=getStyleProperty("geocoderRequest","GeocoderBounds");if(boundsOptions!=null){var sw=new google.maps.LatLng(boundsOptions.sw[0],boundsOptions.sw[1]);var ne=new google.maps.LatLng(boundsOptions.ne[0],boundsOptions.ne[1]);return new google.maps.LatLngBounds(sw,ne)}else{return null}}function closeInfoWindow(){if(openInfoWindow!=null){eventInfoHandler.closeInfoWindow(openInfoWindow)}currentEvent=null}function ensureStyles(){if(!styles){console.log("GeoViewer: styles are undefined");return false}return true}function ensureLoadingOverlay(){if(loadingOverlay==null){var img=getStyleProperty("loadingOverlay","LoadingImage");if(img!=null){loadingOverlay=new GeoLoadingOverlay(img[0],map)}}}function ensureCrosshairsOverlay(){if(crosshairsOverlay==null){var h=getStyleProperty("crosshairsOverlay","CrosshairsHorizontal");var v=getStyleProperty("crosshairsOverlay","CrosshairsVertical");crosshairsOverlay=new GeoCrosshairsOverlay(h[0],h[1],v[0],v[1],map)}}function midpointOnPath(path){if(path.length<1){return null}else{if(path.length==1){return path[0]}}var length=0;for(var i=0;i<path.length-1;i++){length+=segLength(path[i+1],path[i])}length/=2;var runLength=0;for(var i=0;i<path.length-1;i++){var segment=segLength(path[i+1],path[i]);runLength+=segment;if(runLength>=length){segment/=segment-(runLength-length);return new google.maps.LatLng(path[i].lat()+(path[i+1].lat()-path[i].lat())/segment,path[i].lng()+(path[i+1].lng()-path[i].lng())/segment)}}}function centroidOfPoints(path){if(path.length<1){return null}else{if(path.length==1){return path[0]}}var lat=0;var lng=0;for(var i=0;i<path.length;i++){lat+=path[i].lat();lng+=path[i].lng()}return new google.maps.LatLng(lat/path.length,lng/path.length)}function segLength(latLng1,latLng2){return Math.sqrt(Math.pow(latLng2.lat()-latLng1.lat(),2)+Math.pow(latLng2.lng()-latLng1.lng(),2))}function ensureMarkerImageOptions(markerImageOptions){if(markerImageOptions.length>1){markerImageOptions[1]=ensureSize(markerImageOptions[1])}if(markerImageOptions.length>2){markerImageOptions[2]=ensurePoint(markerImageOptions[2])}if(markerImageOptions.length>3){markerImageOptions[3]=ensurePoint(markerImageOptions[3])}if(markerImageOptions.length>4){markerImageOptions[4]=ensureSize(markerImageOptions[4])}}function ensureSize(item){if(item instanceof google.maps.Size){return item}else{var size=new google.maps.Size();google.maps.Size.prototype.constructor.apply(size,item);return size}}function ensurePoint(item){if(item instanceof google.maps.Point){return item}else{var point=new google.maps.Point();google.maps.Point.prototype.constructor.apply(point,item);return point}}function getStyleProperty(type,entry){return(styles[type]&&styles[type][entry])||(styles["default"]&&styles["default"][entry])||null}function doNothing(){}};GeoViewer.parsePath=function(e){e=e.replace(/^\s+|\s+$/g,"");e=e.replace(/\s+/g," ").replace(/, /g,",");var b=e.split(" ");var f=new Array();for(var c=0;c<b.length;c++){var a=b[c].split(",");var d=new google.maps.LatLng(a[0],a[1]);f.push(d)}return f};GeoViewer.nodeValue=function(a){if(!a){return""}else{return(a.innerText||a.text||a.textContent)}};function GeoDefaultEventInfo(){this.closeInfoWindow=function(){infoWindow.close()};this.openInfoWindow=function(f,e,d,g){var a=e.getAttribute("href");if(a!=null){var h=e.getAttribute("id");var a=e.getAttribute("href");return window.open(a+"?id="+h)}else{var b=new google.maps.InfoWindow();var c=GeoViewer.nodeValue(e.getElementsByTagName("Description")[0]);b.setContent(c);if(f instanceof google.maps.Marker){b.open(g,f)}else{b.setPosition(d);b.open(g)}return b}};this.isBlip=function(a){return false}}function GeoLoadingOverlay(c,b){var e=b.getDiv();var d=document.createElement("img");d.src=c;d.style.visibility="hidden";e.appendChild(d);this.show=function(){a();d.style.visibility="visible"};this.hide=function(){d.style.visibility="hidden"};function a(){var f=e.clientHeight*0.2;d.style.width=f+"px";d.style.height=f+"px";d.style.border="0";d.style.position="absolute";d.style.top=((e.clientHeight-f)/2)+"px";d.style.left=((e.clientWidth-f)/2)+"px";d.style.zIndex="500"}}function GeoCrosshairsOverlay(k,i,e,d,b){var a=b.getDiv();var g=i;var c=d;var f=document.createElement("img");var h=document.createElement("img");f.src=k;f.style.visibility="hidden";a.appendChild(f);h.src=e;h.style.visibility="hidden";a.appendChild(h);this.show=function(){j();f.style.visibility="visible";h.style.visibility="visible"};this.hide=function(){f.style.visibility="hidden";h.style.visibility="hidden"};function j(){f.style.width=g[0]+"px";f.style.height=g[1]+"px";f.style.border="0";f.style.position="absolute";f.style.left=((a.clientWidth-g[0])/2)+"px";f.style.top=((a.clientHeight-g[1])/2)+"px";f.style.zIndex="500";h.style.width=c[0]+"px";h.style.height=c[1]+"px";h.style.border="0";h.style.position="absolute";h.style.left=((a.clientWidth-c[0])/2)+"px";h.style.top=((a.clientHeight-c[1])/2)+"px";h.style.zIndex="500"}};